#!/bin/bash
# ansible-ssh_completion: Bash completion script for ansible-ssh.
# This script provides:
#   1. File name completion for the inventory argument (right after -i).
#   2. Once an inventory file is provided and exists, host completion
#      from that inventory.
#
# To enable completion, source this file in your shell (e.g., add the following line to ~/.bashrc):
#   source /path/to/ansible-ssh_completion

_ansible_ssh_completion() {
    local cur prev inv_index inv_file hostlist
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"

    # Locate the inventory file argument by finding "-i" in the command line.
    inv_index=-1
    for i in "${!COMP_WORDS[@]}"; do
        if [[ "${COMP_WORDS[i]}" == "-i" ]]; then
            inv_index=$((i+1))
            break
        fi
    done

    # If no -i flag is present, do nothing.
    if [ $inv_index -eq -1 ]; then
        return 0
    fi

    # If completing the inventory file argument itself, use standard file completion.
    if [ $COMP_CWORD -eq $inv_index ]; then
        COMPREPLY=( $(compgen -f -- "$cur") )
        return 0
    fi

    # Otherwise, we assume the inventory file argument has been provided.
    inv_file="${COMP_WORDS[$inv_index]}"

    # Check that the inventory file exists.
    if [[ ! -f "$inv_file" ]]; then
        return 0
    fi

    # Now complete hostnames from the provided inventory.
    hostlist=$(ansible-inventory -i "$inv_file" --list 2>/dev/null | jq -r '._meta.hostvars | keys[]' 2>/dev/null)
    COMPREPLY=( $(compgen -W "$hostlist" -- "$cur") )
}

complete -F _ansible_ssh_completion ansible-ssh

